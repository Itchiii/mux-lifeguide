var slideout=new Slideout({panel:document.getElementById("panel"),menu:document.getElementById("menu"),padding:256,tolerance:70,duration:1});document.getElementById("toggle-button").addEventListener("click",function(){slideout.toggle()}),slideout.on("beforeopen",function(){document.getElementById("menu").style.display="block"}),slideout.on("open",function(){document.getElementById("toggle-button").style.transform="translateX(256px)",document.getElementById("menu").style.transform="translateX(0)"}),slideout.on("close",function(){document.getElementById("toggle-button").style.transform="translateX(0)",document.getElementById("menu").style.transform="translateX(-256px)",document.getElementById("menu").style.display="block",setTimeout(function(){document.getElementById("menu").style.display="none"},250)});class Database{constructor(t){this.name=t,this.remoteDB=new PouchDB(`http://localhost:5984/${this.name}`),this.localDB=new PouchDB(t),this.infoRemote.then(function(t){this._syncFromRemoteToLocal()}.bind(this))}get infoRemote(){return this.remoteDB.info()}get infoLocal(){return this.localDB.info()}_putItem(t){let e=new Proxy(t,{get:function(t,e){if(e in t)return t[e];switch(e){case"id":t[e]=makeid(10);break;case"title":t[e]="title";break;case"description":t[e]="description";break;case"lat":case"long":case"rating":t[e]=0;break;case"summary":t[e]="summary";break;default:t[e]=null}return t[e]}});return this.localDB.put({_id:e.id.toString(),title:e.title,description:e.description,lat:e.lat,long:e.long,rating:e.rating,summary:e.summary}).then(function(t){this._syncFromLocalToRemote()}.bind(this)).catch(function(){this.localDB.get(e.id.toString()).then(function(t){return this.localDB.put({_id:e.id.toString(),title:e.title,description:e.description,lat:e.lat,long:e.long,rating:e.rating,summary:e.summary,_rev:t._rev})}.bind(this)).then(function(t){this._syncFromLocalToRemote()}.bind(this)).catch(function(t){console.error(t)})}.bind(this))}_putImage(t,e,o){fetch(e).then(t=>t.blob()).then(e=>{this.localDB.putAttachment(t,o,e,"image/jpg").then(function(){this._syncFromLocalToRemote()}.bind(e,this)).catch(function(){this.localDB.get(t).then(function(n){console.log(n),this.localDB.putAttachment(t,o,n._rev,e,"image/jpg").then(function(t){this._syncFromLocalToRemote()}.bind(this,e)).catch(function(t){console.error(t)})}.bind(this))}.bind(this))})}get allDocsOfLocalDB(){return this.localDB.allDocs({include_docs:!0,attachments:!0})}_getDoc(t){return this.localDB.get(t)}_getAttachment(t,e){return this.localDB.getAttachment(t,e)}_syncFromLocalToRemote(){PouchDB.replicate(this.localDB,this.remoteDB,{live:!1,retry:!1,checkpoint:"source"}).on("change",function(t){}).on("paused",function(t){}).on("active",function(){}).on("denied",function(t){}).on("complete",function(t){}).on("error",function(t){console.error("boo, we hit an error!",t)})}_syncFromRemoteToLocal(){PouchDB.replicate(this.remoteDB,this.localDB,{live:!1,retry:!1,checkpoint:"target"}).on("change",function(t){}).on("paused",function(t){}).on("active",function(){}).on("denied",function(t){}).on("complete",function(t){}).on("error",function(t){console.error("boo, we hit an error!",t)})}}function makeid(t){for(var e="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=o.length,c=0;c<t;c++)e+=o.charAt(Math.floor(Math.random()*n));return e}const locationDB=new Database("locations"),eventDB=new Database("events");fetch("./public/js/init.json").then(function(t){return t.json()}).then(function(t){for(const e of t)locationDB._putItem(e).then(function(){void 0!==e.attachment&&void 0!==e.attachmentName&&locationDB._putImage(e.id,e.attachment,e.attachmentName)})}),locationDB.allDocsOfLocalDB.then(function(t){for(const e of t.rows){const t=document.createElement("div"),o=document.createElement("h1"),n=document.createElement("p");o.innerHTML=e.doc.title,n.innerHTML=e.doc.description,t.append(o),t.append(n),document.getElementById("index").append(t),void 0!==e.doc._attachments&&locationDB._getAttachment(e.doc._id,Object.keys(e.doc._attachments)[0]).then(function(t){console.log("test");var e=URL.createObjectURL(t),o=document.createElement("img");o.src=e,document.body.appendChild(o)})}}),fetch("accessTokenMapBox.txt").then(t=>t.text()).then(t=>{const e=t;var o=L.map("mapid",{zoomControl:!1}).setView([48.37154,10.89851],13);L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:e}).addTo(o),L.Browser.mobile||L.control.zoom({position:"bottomright"}).addTo(o);var n=L.icon({iconUrl:"/public/assets/icons/icon-64.png",iconSize:[32,32],iconAnchor:[16,16]});L.marker([48.36592,10.88924],{icon:n}).addTo(o).bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup(),L.Routing.control({router:L.Routing.mapbox(e),waypoints:[L.latLng(48.36592,10.88924),L.latLng(48.36801,10.89311)],routeWhileDragging:!1,autoRoute:!0,geocoder:L.Control.Geocoder.nominatim()}).addTo(o),locationDB.allDocsOfLocalDB.then(function(t){for(const e of t.rows)void 0!==e.doc.lat&&L.marker([e.doc.lat,e.doc.long],{icon:n}).addTo(o)})}),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.getRegistrations().then(function(t){for(let e of t)e.unregister().then(function(t){t&&console.log("Unregistration succeeded")})}).then(function(){navigator.serviceWorker.register("/service-worker.js",{scope:"./"}).then(function(t){console.log("Registration succeeded.")}).catch(function(t){console.log("Registration failed with "+t)})}).catch(function(t){console.log("Service Worker unregistration failed: ",t)})});