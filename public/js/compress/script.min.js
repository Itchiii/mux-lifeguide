var slideout=new Slideout({panel:document.getElementById("panel"),menu:document.getElementById("menu"),padding:256,tolerance:70,duration:1});document.getElementById("toggle-button").addEventListener("click",function(){slideout.toggle()}),slideout.on("beforeopen",function(){document.getElementById("menu").style.display="block"}),slideout.on("open",function(){document.getElementById("toggle-button").style.transform="translateX(256px)",document.getElementById("menu").style.transform="translateX(0)"}),slideout.on("close",function(){document.getElementById("toggle-button").style.transform="translateX(0)",document.getElementById("menu").style.transform="translateX(-256px)",document.getElementById("menu").style.display="block",setTimeout(function(){document.getElementById("menu").style.display="none"},250)});const title=document.title,url=document.querySelector("link[rel=canonical]")?document.querySelector("link[rel=canonical]").href:document.location.href;function setRecommend(t){switch(t){case eventDB:eventDB._getDocByFind("recommend",!0).then(function(t){setAllTips(eventDB,t)});break;case locationDB:locationDB._getDocByFind("recommend",!0).then(function(t){setAllTips(locationDB,t)});break;case tourDB:tourDB._getDocByFind("recommend",!0).then(function(t){setAllTips(tourDB,t)})}}function setAllTips(t,e){for(const n of e.docs){const e=document.getElementById("location-tips"),o=document.getElementById("event-tips"),c=document.getElementById("tour-tips");let i;switch(t){case eventDB:i=o;break;case locationDB:i=e;break;case tourDB:i=c}const a=document.createElement("article"),r=document.createElement("img"),s=document.createElement("h4");void 0!==n._attachments?t._getAttachment(n._id,Object.keys(n._attachments)[0]).then(function(t){let e=URL.createObjectURL(t);r.src=e,a.append(r),a.append(s),i.append(a)}).catch(function(t){console.error(t)}):(a.append(r),a.append(s),i.append(a)),s.textContent=n.title}}function setTipWithJSON(t,e){const n=document.getElementById("location-tips"),o=document.getElementById("event-tips"),c=document.getElementById("tour-tips");let i;switch(t){case eventDB:i=o;break;case locationDB:i=n;break;case tourDB:i=c}const a=document.createElement("article"),r=document.createElement("img"),s=document.createElement("h4");void 0!==e.attachmentName?t._getAttachment(e.id,e.attachmentName).then(function(t){let e=URL.createObjectURL(t);r.src=e,a.append(r),a.append(s),i.append(a)}).catch(function(t){console.error(t)}):(a.append(r),a.append(s),i.append(a)),s.textContent=e.title}document.getElementById("share-button").addEventListener("click",t=>{navigator.share&&navigator.share({title:title,url:url}).then(()=>{console.log("Thanks for sharing!")}).catch(console.error)});class Database{constructor(t){this.name=t,this.remoteDB=new PouchDB(`http://localhost:5984/${this.name}`),this.localDB=new PouchDB(t),this.infoRemote.then(function(t){this._syncFromRemoteToLocal()}.bind(this))}get infoRemote(){return this.remoteDB.info()}get infoLocal(){return this.localDB.info()}_putItem(t,e,n){let o=new Proxy(t,{get:function(t,e){if(e in t)return t[e];switch(e){case"id":t[e]=makeid(10);break;case"title":t[e]="title";break;case"description":t[e]="description";break;case"lat":case"long":case"rating":t[e]=0;break;case"summary":t[e]="summary";break;case"recommend":t[e]=!1;break;default:t[e]=null}return t[e]}});this.localDB.put({_id:o.id.toString(),title:o.title,description:o.description,lat:o.lat,long:o.long,rating:o.rating,summary:o.summary,recommend:o.recommend}).then(function(t){e(),this._syncFromLocalToRemote()}.bind(this)).catch(function(){this.localDB.get(o.id.toString()).then(function(t){this.localDB.put({_id:o.id.toString(),title:o.title,description:o.description,lat:o.lat,long:o.long,rating:o.rating,summary:o.summary,recommend:o.recommend,_rev:t._rev})}.bind(this)).then(function(t){e(),this._syncFromLocalToRemote()}.bind(this)).catch(function(t){console.error(t)})}.bind(this))}_putImage(t,e,n,o,c){fetch(e).then(t=>t.blob()).then(e=>{this.localDB.putAttachment(t,n,e,"image/jpg").then(function(){this._syncFromLocalToRemote(),o()}.bind(e,this)).catch(function(){this.localDB.get(t).then(function(c){this.localDB.putAttachment(t,n,c._rev,e,"image/jpg").then(function(t){this._syncFromLocalToRemote(),o()}.bind(this,e)).catch(function(t){console.error(t)})}.bind(this))}.bind(this))})}get allDocsOfLocalDB(){return this.localDB.allDocs({include_docs:!0,attachments:!0})}_getDoc(t){return this.localDB.get(t)}_getAttachment(t,e){return this.localDB.getAttachment(t,e)}_getDocByFind(t,e){return this.localDB.createIndex({index:{fields:[t]}}).then(function(){return this.localDB.find({selector:{[t]:e}})}.bind(this))}_syncFromLocalToRemote(){return PouchDB.replicate(this.localDB,this.remoteDB,{live:!1,retry:!1,checkpoint:"source"}).on("change",function(t){}).on("paused",function(t){}).on("active",function(){}).on("denied",function(t){}).on("complete",function(t){}).on("error",function(t){})}_syncFromRemoteToLocal(){return PouchDB.replicate(this.remoteDB,this.localDB,{live:!1,retry:!1,checkpoint:"target"}).on("change",function(t){}).on("paused",function(t){}).on("active",function(){}).on("denied",function(t){}).on("complete",function(t){}).on("error",function(t){})}}function makeid(t){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,c=0;c<t;c++)e+=n.charAt(Math.floor(Math.random()*o));return e}const locationDB=new Database("locations"),eventDB=new Database("events"),tourDB=new Database("tours");function fetchJson(){fetch("./public/js/init.json").then(function(t){return t.json()}).then(function(t){for(const e of t){new Promise(function(t,n){eventDB._putItem(e,t,n)}).then(function(t){if(void 0!==e.attachment&&void 0!==e.attachmentName){new Promise(function(t,n){eventDB._putImage(e.id,e.attachment,e.attachmentName,t,n)}).then(function(t){setTipWithJSON(eventDB,e)})}}),new Promise(function(t,n){tourDB._putItem(e,t,n)}).then(function(t){if(void 0!==e.attachment&&void 0!==e.attachmentName){new Promise(function(t,n){tourDB._putImage(e.id,e.attachment,e.attachmentName,t,n)}).then(function(t){setTipWithJSON(tourDB,e)})}}),new Promise(function(t,n){locationDB._putItem(e,t,n)}).then(function(t){if(void 0!==e.attachment&&void 0!==e.attachmentName){new Promise(function(t,n){locationDB._putImage(e.id,e.attachment,e.attachmentName,t,n)}).then(function(t){setTipWithJSON(locationDB,e)})}})}})}locationDB._syncFromRemoteToLocal().on("complete",function(t){setRecommend(locationDB),fetchJson()}).on("error",function(t){setRecommend(locationDB)}),eventDB._syncFromRemoteToLocal().on("complete",function(t){setRecommend(eventDB)}).on("error",function(t){setRecommend(eventDB)}),tourDB._syncFromRemoteToLocal().on("complete",function(t){setRecommend(tourDB)}).on("error",function(t){setRecommend(tourDB)}),locationDB.allDocsOfLocalDB.then(function(t){for(const e of t.rows){const t=document.createElement("div"),n=document.createElement("h1"),o=document.createElement("p");n.innerHTML=e.doc.title,o.innerHTML=e.doc.description,t.append(n),t.append(o),document.getElementById("events").append(t),void 0!==e.doc._attachments&&locationDB._getAttachment(e.doc._id,Object.keys(e.doc._attachments)[0]).then(function(t){console.log("test");var e=URL.createObjectURL(t),n=document.createElement("img");n.src=e,document.body.appendChild(n)})}}),fetch("accessTokenMapBox.txt").then(t=>t.text()).then(t=>{const e=t,n=L.map("mapid",{zoomControl:!1}).setView([48.37154,10.89851],13);L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:e}).addTo(n);const o=L.icon({iconUrl:"/public/assets/icons/icon-64.png",iconSize:[32,32],iconAnchor:[16,16]});L.marker([48.36592,10.88924],{icon:o}).addTo(n).bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup(),L.Routing.control({router:L.Routing.mapbox(e),waypoints:[L.latLng(48.36592,10.88924),L.latLng(48.36801,10.89311)],routeWhileDragging:!1,autoRoute:!0,geocoder:L.Control.Geocoder.nominatim()}).addTo(n),L.Control.geocoder({collapsed:!1,placeholder:"Nach Orten suchen..."}).addTo(n),L.control.locate({position:"topright",icon:"icon-geolocate",iconElementTag:"span"}).addTo(n),document.querySelector(".icon-geolocate").insertAdjacentHTML("afterbegin",'<svg class="icon-geolocate-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">\n  <path fill="none" stroke="#202020" stroke-miterlimit="10" stroke-width="4" d="M32 2v16m0 28v16M18 32H2m60 0H46" stroke-linejoin="round" stroke-linecap="round"/>\n  <circle cx="32" cy="32" r="22" fill="none" stroke="#202020" stroke-miterlimit="10" stroke-width="4" stroke-linejoin="round" stroke-linecap="round"/>\n</svg>'),locationDB.allDocsOfLocalDB.then(function(t){for(const e of t.rows)void 0!==e.doc.lat&&L.marker([e.doc.lat,e.doc.long],{icon:o}).addTo(n)})}),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.getRegistrations().then(function(t){for(let e of t)e.unregister().then(function(t){t&&console.log("Unregistration succeeded")})}).then(function(){navigator.serviceWorker.register("/service-worker.js",{scope:"./"}).then(function(t){console.log("Registration succeeded.")}).catch(function(t){console.log("Registration failed with "+t)})}).catch(function(t){console.log("Service Worker unregistration failed: ",t)})});